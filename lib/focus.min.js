(function(k){var x={KEYS:{"LEFT":37,"RIGHT":39,"UP":38,"DOWN":40},KEYSMAP:{"LEFT":"RIGHT","RIGHT":"LEFT","UP":"DOWN","DOWN":"UP"},direction:{"111":"RIGHT","101":"RIGHT","100":"UP","000":"UP","011":"LEFT","001":"LEFT","010":"DOWN","110":"DOWN"},cacheable:true,cacheTime:2000,};var n={lastFocus:undefined,curFocus:undefined,directive:undefined,cacheTiemoutId:undefined,cacheTime:x.cacheTime,setFocusCahce:function(G,H){var F=this;F.lastFocus=F.curFocus;F.curFocus=G;F.directive=H;if(F.lastFocus){if(F.cacheTiemoutId){clearTimeout(F.cacheTiemoutId)}F.cacheTiemoutId=setTimeout(function(){F.lastFocus=undefined},F.cacheTime)}},getFocusCache:function(I,J){var G=this;var H=x.KEYSMAP[J];var F;if(I==G.curFocus&&H==G.directive){F=G.lastFocus}return F},setCacheTime:function(F){x.cacheTime=F}};var w=[];var q=(function(){function F(){}function H(M,J,N){for(var L=0;L<w.length;L++){if(w[L].level==J){var I=w[L].groups;for(var K=0;K<I.length;K++){if(I[K].group==N){return I[K].elements}}}}return null}function G(J){for(var I=0;I<w.length;I++){if(w[I].level==J){return w[I].groups}}return null}return{flushTree:F(),getElementGroup:H,getTreeGroup:G}})();function t(F,I){if(!F){F=[]}for(var G=0;G<I.length;G++){I[G]=k(I[G])}var J=false;for(var H=0;H<F.length;H++){if(F[H].group=="default"){F[H].elements.concat(I);J=true}}if(!J){F.push({"group":"default","elements":I})}}function j(I){var F=[{"group":"default","elements":[]}];for(var G=0;G<I.length;G++){var K=k(I[G]).parents().attr("data-focus-group");if(K){var J=false;for(var H=0;H<F.length;H++){if(F[H].group==K){F[H].elements.push(k(I[H]));J=true;break}}if(!J){F.push({"group":K,"elements":[k(I[G])]})}}else{F[0].elements.push(k(I[G]))}}w.push({"level":"default","groups":F})}function r(){if(w.length>0){w=[]}var H=k("[data-focus-level]");var J=k("[focusable]");for(var U=0;U<H.length;U++){var F=H[U];console.log(k(F));var L=k(F).data("focusLevel");var O=k("[data-focus-level="+L+"] [focusable]");var P=[];var W=k(F).find("[data-focus-group]");var X=[];for(var T=0;T<W.length;T++){var K=W[T];var M=k(K).data("focusGroup");var N=[];groupElements=k(K).find("[focusable]");for(var S=0;S<groupElements.length;S++){O.splice(k.inArray(groupElements[S],O),1);J.splice(k.inArray(groupElements[S],J),1);N.push(k(groupElements[S]))}var I={"group":M,"elements":N};var V=false;for(var R=0;R<X.length;R++){if(X[R].group==I.group){X[R].elements.concat(N);V=w;break}}if(!V){X.push(I)}}if(O.length>0){for(var Q=0;Q<O.length;Q++){J.splice(k.inArray(O[Q],J),1)}t(X,O)}var G={"level":L,"groups":X};w.push(G)}if(J.length>0){j(J)}console.log("build result",w)}function B(G){var F={};F.height=G.height();F.width=G.width();var H=G.offset();F.left=H.left;F.top=H.top;return F}function h(H){var G=B(H);var F={};F.x=G.left+G.width/2;F.y=G.top+G.height/2;return F}function D(G,F){return Math.sqrt(Math.pow(G.x-F.x,2)+Math.pow(G.y-F.y,2))}function y(F,I,J){var G=I[0];var H=h(k(G));var L=h(k(F));var K=0;switch(J){case"UP":K=L.y-H.y;break;case"DOWN":K=H.y-L.y;break;case"LEFT":K=L.x-H.x;break;case"RIGHT":K=H.x-L.x;break}return K}function C(K,G){var F=G.x-K.x;var J=G.y-K.y;var I="";function H(L){if(L){I+="1"}else{I+="0"}}H(F>=0);H(J>=0);H(Math.abs(F)>=Math.abs(J));console.log(x.direction[I]);return x.direction[I]}function d(I,F){var G=I.parents();for(var H=0;H<G.length;H++){var J=G[H];if(J.tagName=="BODY"){if(!F.group){F.group="default"}F.level="default";return F}if(k(J).attr("data-focus-group")&&!F.level){F.group=k(J).data("focusGroup")}if(k(J).attr("data-focus-level")){if(!F.group){F.group="default"}F.level=k(J).data("focusLevel");return F}}}function g(G,F,M){var K={};var L=h(G);for(var I=0;I<F.length;I++){var J=F[I];var N=h(J);if(L.x==N.x&&L.y==N.y){continue}else{if(!M||C(L,N)==M){var H=D(L,N);if(!K.distance||H<K.distance){K.distance=H;K.element=J}}}}return K}function i(H,G,N){var L={};var M=h(H);for(var J=0;J<G.length;J++){var K=G[J];var O=h(K);if(M.x==O.x&&M.y==O.y){continue}else{var F=false;switch(N){case"LEFT":F=(M.x-O.x)>0;break;case"RIGHT":F=(O.x-M.x)>0;break;case"UP":F=(M.y-O.y)>0;break;case"DOWN":F=(O.y-M.y)>0;break}if(F){var I=D(M,O);if(!L.distance||I<L.distance){L.distance=I;L.element=K}}}}return L}function u(H,G,J){var F;elements=q.getElementGroup(H,G.level,G.group);var I=g(H,elements,J);if(I.element&&I.distance){F=I}else{I=i(H,elements,J);if(I.element&&I.distance){F=I}}return F}function p(L,J,M){var G=q.getTreeGroup(J.level);var H=9999;var K;var N;for(var I=0;I<G.length;I++){if(G[I].group==J.group){continue}else{var F=y(L,G[I].elements,M);if(F>0&&F<H){H=F;N=G[I].elements}}}if(N){var K=g(L,N);if(K.element&&K.distance){return K.element}else{return}}return}function b(H,G,L){var F=q.getTreeGroup(G.level);var J=9999;var K;for(var I=0;I<F.length;I++){if(F[I].group==G.group){continue}else{G.group=F[I].group;hasNext=u(H,G,L);if(hasNext){if(hasNext.distance<J){J=hasNext.distance;K=hasNext.element}}}}return K}function f(I){var H=false;var G=n.curFocus;var F=n.getFocusCache(G,I);if(F){c(F,G);n.setFocusCahce(F,I);H=true}return H}function s(K){var G=false;
var F=n.curFocus;var J;var H=F.data("focusNext");for(key in H){var I=key.toUpperCase();if(I==K){J=H[key];break}}if(J){c(k(J),F);n.setFocusCahce(k(J),K);G=true}return G}function a(J){var H=n.curFocus;var G={};d(H,G);if(G.level&&G.group){var F=u(H,G,J);if(F){c(F.element,H);n.setFocusCahce(F.element,J);return}else{var I=p(H,G,J);if(I){c(I,H);n.setFocusCahce(I,J)}}}}function c(G,F){if(F){F.removeClass("focused")}G.addClass("focused")}function m(F){var G=n.lastFocus;if(G){k(G).removeClass("focused")}k(F).addClass("focused");n.setFocusCahce(k(F))}function o(F){if(typeof true=="boolean"){x.cacheable=false}else{console.log("cacheable can not be non boolean")}}function E(F){if(!isNaN(F)){x.cacheTime=F}else{console.log("time can not be a none nunber")}}function A(F){if(k(F+".[focusable]").length>0){k(F).removeAttr("focusable");r();console.log(w)}}function l(F){if(k(F+".[focusable]").length==0){k(F).attr("focusable","");r()}}function v(){var F=(function(){return{setFocus:m,flushTree:r,enbleCache:o,setCacheTime:E,disableFocus:A,enableFocus:l,}})();k.extend({FocusManage:F})}function e(F){if(x.enbleCache&&f(F)){return}if(s(F)){return}a(F)}function z(){r();k(window).keydown(function(F){switch(F.keyCode){case x.KEYS.LEFT:e("LEFT");break;case x.KEYS.RIGHT:e("RIGHT");break;case x.KEYS.UP:e("UP");break;case x.KEYS.DOWN:e("DOWN");break;default:break}});v()}k(document).ready(z)})(jQuery);